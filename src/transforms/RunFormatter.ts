import booleanPointInPolygon from "@turf/boolean-point-in-polygon";
import turfCenter from "@turf/center";
import * as turf from "@turf/helpers";
import { AllGeoJSON } from "@turf/helpers";
import {
  FeatureType,
  RunDifficulty,
  RunDifficultyConvention,
  RunGrooming,
  RunUse,
  SourceType,
  Status,
} from "openskidata-format";
import { osmID } from "../features/OSMGeoJSONProperties";
import { InputRunFeature, OSMRunTags } from "../features/RunFeature";
import notEmpty from "../utils/notEmpty";
import buildFeature from "./FeatureBuilder";
import {
  FormattedInputRunFeature,
  FormattedInputRunProperties,
} from "./FormattedInputRunFeature";
import { Omit } from "./Omit";
import {
  getOSMFirstValue,
  getOSMName,
  mapOSMBoolean,
  mapOSMString,
} from "./OSMTransforms";
import getStatusAndValue from "./Status";

export function formatRun(
  feature: InputRunFeature,
): FormattedInputRunFeature[] {
  if (feature.geometry.type === "Point") {
    return [];
  }

  const tags = feature.properties.tags;

  const { status, uses } = getStatusAndUses(tags);
  if (uses.length === 0) {
    return [];
  }

  if (status !== Status.Operating) {
    return [];
  }

  const ref = mapOSMString(getOrElse(tags, "piste:ref", "ref"));
  const properties: Omit<FormattedInputRunProperties, "id"> = {
    type: FeatureType.Run,
    uses: uses,
    name: getOSMName(tags, "piste:name", "name", ref),
    ref: ref,
    description: mapOSMString(
      getOrElse(tags, "piste:description", "description"),
    ),
    difficulty: getDifficulty(tags),
    difficultyConvention: getRunDifficultyConvention(feature),
    oneway: getOneway(tags, uses),
    gladed: getGladed(tags),
    patrolled: mapOSMBoolean(getOrElse(tags, "piste:patrolled", "patrolled")),
    lit: mapOSMBoolean(getOrElse(tags, "piste:lit", "lit")),
    grooming: getGrooming(tags),
    skiAreas: [],
    status: status,
    sources: [
      { type: SourceType.OPENSTREETMAP, id: osmID(feature.properties) },
    ],
    websites: [tags.website].filter(notEmpty),
    wikidata_id: getOSMFirstValue(tags, "wikidata"),
  };

  // Handle MultiPolygon by splitting into separate Polygon features
  if (feature.geometry.type === "MultiPolygon") {
    return feature.geometry.coordinates.map((polygonCoords) => {
      const polygonGeometry: GeoJSON.Polygon = {
        type: "Polygon",
        coordinates: polygonCoords,
      };
      return buildFeature(polygonGeometry, properties);
    });
  }

  return [buildFeature(feature.geometry, properties)];
}

function getStatusAndUses(tags: OSMRunTags) {
  let { status, value: pisteType } = getStatusAndValue(
    "piste:type",
    tags as { [key: string]: string },
  );

  // Special case status check for runs: https://wiki.openstreetmap.org/wiki/Piste_Maps
  if (tags["piste:abandoned"] === "yes") {
    status = Status.Abandoned;
  }

  const uses = pisteType !== null ? getUses(pisteType) : [];
  return { status, uses };
}

function getUses(type: string): RunUse[] {
  return type
    .split(";")
    .map((t) => t.trim().toLowerCase())
    .flatMap((t) =>
      Object.values(RunUse).includes(t as RunUse) ? [t as RunUse] : [],
    );
}

function getGladed(tags: OSMRunTags): boolean | null {
  const gladedTag = mapOSMBoolean(getOrElse(tags, "piste:gladed", "gladed"));
  if (gladedTag !== null) {
    return gladedTag;
  }

  if (tags["natural"] === "wood" || tags["landuse"] === "forest") {
    return true;
  }

  return null;
}

function getOneway(tags: OSMRunTags, uses: RunUse[]): boolean | null {
  const value = mapOSMBoolean(getOrElse(tags, "piste:oneway", "oneway"));
  if (value !== null) {
    return value;
  }

  if (uses.includes(RunUse.Downhill)) {
    return true;
  }

  return null;
}

function getOrElse<P extends { [key: string]: string | undefined }>(
  properties: P,
  key: keyof P,
  fallbackKey: keyof P,
): string | undefined {
  const value = properties[key];
  if (value !== undefined) {
    return value;
  }

  const fallback = properties[fallbackKey];
  if (fallback !== undefined) {
    return fallback;
  }

  return undefined;
}

function getGrooming(tags: OSMRunTags): RunGrooming | null {
  const value = tags["piste:grooming"]?.replace(";", "+");
  if (value) {
    const values = new Set(value.split("+"));

    if (values.has(RunGrooming.Classic) && values.has(RunGrooming.Skating)) {
      return RunGrooming.ClassicAndSkating;
    }

    if (Object.values(RunGrooming).includes(value as RunGrooming)) {
      return value as RunGrooming;
    }
  }

  // Default to piste:grooming = backcountry for the most difficult runs
  if (
    tags["piste:difficulty"] === "expert" ||
    tags["piste:difficulty"] === "freeride" ||
    tags["piste:difficulty"] === "extreme"
  ) {
    return RunGrooming.Backcountry;
  }

  if (tags["piste:grooming"] === "no") {
    return RunGrooming.Backcountry;
  }

  return null;
}

function getDifficulty(tags: OSMRunTags): RunDifficulty | null {
  const value = tags["piste:difficulty"];
  return value && Object.values(RunDifficulty).includes(value as RunDifficulty)
    ? (value as RunDifficulty)
    : null;
}

export function getRunDifficultyConvention(
  geojson: AllGeoJSON,
): RunDifficultyConvention {
  const point = turfCenter(geojson).geometry;
  if (!point) {
    throw "Cannot determine center of geometry";
  }

  if (booleanPointInPolygon(point, japanConventionGeometry)) {
    return RunDifficultyConvention.JAPAN;
  } else if (booleanPointInPolygon(point, northAmericanConventionGeometry)) {
    return RunDifficultyConvention.NORTH_AMERICA;
  } else {
    return RunDifficultyConvention.EUROPE;
  }
}

const northAmericanConventionGeometry = turf.multiPolygon([
  [
    [
      [66.89889168301036, 22.98946421817959],
      [76.79011657384558, 4.2607118936878265],
      [112.5459757578734, -40.008871147786486],
      [166.64372809287335, -58.19200446079054],
      [191.91699393212554, -33.377687858720755],
      [192.65370948033006, -8.971607939355977],
      [140.68354997294796, 5.451024881476499],
      [123.38582294700518, 21.801329456101513],
      [122.25942048875993, 24.243081370534554],
      [123.02414890399393, 26.354744126525432],
      [129.68307711216244, 35.3374262814546],
      [131.36509887116028, 39.1827837685222],
      [130.5715844381864, 42.515964349309684],
      [130.62108313985783, 42.63370843853855],
      [130.39263902117034, 42.73714858581644],
      [130.8150956808529, 42.87954610777132],
      [131.04334909066392, 42.88226217082041],
      [131.33954328617205, 43.445079879213296],
      [131.191137752773, 43.53879786242706],
      [131.2860140618261, 44.06115319070142],
      [131.1086866768622, 44.71097030226514],
      [130.95332209785204, 44.84377389211244],
      [131.56223386930952, 45.01998391706314],
      [131.87876159757576, 45.342467064732745],
      [131.9445424786545, 45.26381674117374],
      [132.89886314033083, 45.04768363738535],
      [132.9409663928247, 45.020634782943716],
      [133.12560828825156, 45.14828761444474],
      [133.11406817721956, 45.23774574998686],
      [133.1686920707706, 45.49559658174417],
      [133.4044528436404, 45.59600211321589],
      [133.49367119277423, 45.87840483196845],
      [133.57649823904808, 45.88061866181769],
      [133.7230811284722, 46.06662995573109],
      [133.68166349871666, 46.137321119014274],
      [133.9014556853037, 46.24315756590036],
      [134.29060710292293, 47.44981009549741],
      [134.53603145724082, 47.47580868032259],
      [134.80050117570937, 47.73143995381383],
      [134.54808493637842, 48.00270638588145],
      [134.7902354911858, 48.38077517538687],
      [134.53852703049813, 48.414602674179406],
      [134.05426284432252, 48.33207866806839],
      [133.44255382292891, 48.11130941788082],
      [133.06661598961256, 48.102793716410616],
      [132.65561957214425, 47.92377254119751],
      [132.57597035647728, 47.73126763647102],
      [131.5872859174675, 47.669086096155525],
      [130.978760673039, 47.70552624852317],
      [130.8927298265839, 47.92147467660291],
      [130.69208001471225, 48.07898424194457],
      [130.8424973965307, 48.32747681044523],
      [130.53333624266037, 48.638203333369944],
      [130.69902773150022, 48.86294984494779],
      [130.4313260036679, 48.91144552665949],
      [130.2336273608912, 48.877796693265594],
      [129.49472335519903, 49.445146325369194],
      [128.6404925727599, 49.6395594299683],
      [127.95892224407356, 49.62425806475295],
      [127.56973394676123, 49.842755131278835],
      [127.6749910879272, 50.240140628289964],
      [127.45368458653832, 50.26847480259133],
      [127.37394005798404, 50.29288471184299],
      [127.32612719828853, 50.34379944487219],
      [127.37997900840315, 50.60653687131031],
      [127.16325020595207, 50.933036917572906],
      [126.99177818739395, 51.326954509452236],
      [126.33131963313707, 52.493153867333206],
      [126.09655832692533, 52.86710580508279],
      [125.18461572471739, 53.21778527809076],
      [123.62905555865535, 53.56957077991163],
      [122.14662682326076, 53.507610554797225],
      [120.81940759451805, 53.31174251524433],
      [119.95478692741125, 52.77983494498105],
      [120.02183577608542, 52.55624852160162],
      [120.59821023820314, 52.5562523256705],
      [120.65182146309388, 52.027454302929755],
      [120.00845804883363, 51.63400833664596],
      [119.10923570584242, 50.3653464992334],
      [119.33042992474253, 50.30545934524457],
      [119.21648675850292, 50.099528593865784],
      [118.93783039700338, 49.98458223887849],
      [118.54626899510839, 49.94616013995508],
      [117.80663959739081, 49.53647108800752],
      [117.484738258086, 49.624317990557614],
      [117.26607476489426, 49.63477188589076],
      [116.96468681768641, 49.73160402967815],
      [116.62825050755794, 49.944503706705376],
      [116.2287910451044, 50.03623236447976],
      [115.97912115005505, 49.97893073129566],
      [115.72585372832015, 49.87560524136032],
      [115.38340104847777, 49.935338883138456],
      [115.15157871232401, 50.03624558574222],
      [114.96972180858182, 50.18262812854161],
      [114.32823723216535, 50.27374466694857],
      [113.21615782676918, 49.84014337192383],
      [113.06279976594055, 49.60262851502978],
      [112.75961978011298, 49.50544853175836],
      [112.4528903096238, 49.51941937053812],
      [111.93911320274538, 49.37324774723086],
      [111.69083700584588, 49.38804243172055],
      [110.68965090965844, 49.16705432804406],
      [108.61062678042163, 49.33457873762259],
      [107.90316280555385, 49.97532248790398],
      [106.49948671672877, 50.3809827302172],
      [105.51746011619525, 50.48702476586922],
      [103.97795584841299, 50.133831277984996],
      [102.69196601175406, 50.37681484681099],
      [102.27144249887641, 50.87948727040293],
      [102.17444849785716, 51.35640391793228],
      [100.63003834780625, 51.738599556839574],
      [98.92412930445079, 52.152271807237554],
      [98.0263146497278, 51.38702212297895],
      [97.83223938583137, 50.91503753447586],
      [98.30141292582249, 50.51549014567553],
      [98.03452228766315, 50.01401927081076],
      [97.21087912958029, 49.75344974439781],
      [96.59617521697089, 49.92558626439808],
      [94.58073504473032, 50.071206832869876],
      [94.44884921665886, 50.25288523325358],
      [94.28227879098631, 50.59029357818193],
      [93.06055432240078, 50.6108167038102],
      [92.95500531764452, 50.764378755264715],
      [92.38044935493656, 50.81536176617482],
      [89.61447548394369, 49.896510834163024],
      [89.41209157088667, 49.593951299041436],
      [87.21941106111126, 49.136371106937105],
      [86.47691458036888, 48.52706996107682],
      [85.66792655187515, 48.41217050021373],
      [85.61001315938637, 47.097608820611185],
      [83.06577876367635, 47.1684932958469],
      [82.19603900970611, 45.39598594758252],
      [79.94680702146206, 44.995940936938524],
      [80.74758671786947, 43.25101970631087],
      [80.16296382083789, 42.42004311892032],
      [79.08808560905646, 42.80565581050615],
      [77.46543003728954, 42.93866114713731],
      [77.30266016034727, 42.91577009179525],
      [77.06944317811468, 42.98941184436538],
      [76.83954492079482, 42.95784584611252],
      [76.66706605000616, 42.91054018927406],
      [76.35054751194656, 42.86314251596045],
      [76.22106905960021, 42.92109675548289],
      [75.8499512176796, 42.944841027684475],
      [75.69647619703395, 42.79434701877443],
      [75.20518050373951, 42.86058166470994],
      [74.86716288299183, 42.99486162795807],
      [74.21214208437436, 43.26799034589942],
      [73.54918053004673, 43.03445951036437],
      [73.43569691290458, 42.59058989745361],
      [73.50713573720739, 42.42885549027292],
      [73.32430827244477, 42.43964242187812],
      [73.28138720704561, 42.524654623049486],
      [72.89688006931604, 42.53825798475941],
      [72.7028920768594, 42.65445195418786],
      [71.8205490156389, 42.84297257066001],
      [71.24172502287257, 42.76218198674192],
      [70.96542642702568, 42.45295945325228],
      [70.87574064610243, 42.288978943546994],
      [70.93667564676599, 42.25956939262474],
      [71.0522698554054, 42.28801700409892],
      [71.26892670629547, 42.19664779423837],
      [70.22467025584973, 41.6109136918285],
      [70.1871419707528, 41.52357559397731],
      [70.29521282660394, 41.5196557335768],
      [70.4885172051716, 41.39563567019803],
      [70.6908234400903, 41.47973822440426],
      [70.78334977579652, 41.37596799777336],
      [70.7936135992125, 41.23200478517444],
      [71.40193377758987, 41.189890843929476],
      [71.72132931443616, 41.463007098837124],
      [72.25976659039807, 41.036213505586716],
      [73.12473655458163, 40.821214468109844],
      [71.8274169831183, 40.219535506292345],
      [71.2093915709481, 40.35194316359275],
      [70.70839519610914, 40.047767583705706],
      [70.00814064760502, 40.19597188360018],
      [69.3238929275289, 39.96163997362652],
      [69.25288425833449, 39.8365015771121],
      [69.36807176732333, 39.53622995828479],
      [70.5656905159378, 39.611522993563625],
      [70.81017094805003, 39.40296443017286],
      [71.05478901580443, 39.42623263483682],
      [71.09537841230028, 39.521081174175976],
      [71.48723105871241, 39.61179598590786],
      [71.80293870931277, 39.289369010362776],
      [72.03176071465103, 39.344791211184486],
      [72.22037536907436, 39.19478948035075],
      [72.34794908849406, 39.34434407454637],
      [73.15397827282933, 39.35800161267082],
      [73.41580743762637, 39.46694232025965],
      [73.60494023346439, 39.469004217709056],
      [73.53306087489301, 39.24817612724672],
      [73.8401473956308, 38.955283153545196],
      [73.7178756559239, 38.88418224181672],
      [73.84575285445322, 38.5733588129749],
      [74.19825648155071, 38.625225936216],
      [74.73465165940527, 38.39729684471283],
      [74.94429646804616, 37.74563365375093],
      [75.09730124153691, 37.34874288728962],
      [74.47556092367677, 37.22736548435755],
      [74.52571774786139, 37.04804932382365],
      [72.64281263069017, 36.9965169904729],
      [71.27151437563325, 36.14385342653641],
      [71.70051938813555, 35.31553980310994],
      [70.91367870839377, 34.02947262017156],
      [69.8657881549984, 33.97753268150575],
      [70.19479291508452, 33.38872790844742],
      [69.48427263502771, 32.94309627730759],
      [69.17043362955638, 31.802649394624297],
      [66.5660130962763, 31.1468844695182],
      [66.39058495939196, 29.902900359253024],
      [64.20728972399988, 29.470320322411112],
      [62.39830055544061, 29.433474533828033],
      [60.82809795436239, 29.876493049104326],
      [61.819412883544715, 28.5413645023537],
      [62.838210084807116, 28.1758941784838],
      [62.87712480493187, 26.710220153319582],
      [61.95649723937791, 26.202543172995433],
      [61.64164473778666, 25.062349569223997],
      [66.89889168301036, 22.98946421817959],
    ],
  ],
  [
    [
      [-79.49790751939359, 8.895517276865164],
      [-80.09116426661198, 9.489400626216977],
      [-71.5226805789838, 14.570830502555324],
      [-64.296660455746, 16.87497218957077],
      [-63.50670575144407, 19.468079078229948],
      [-46.04319359052067, 49.81687541607755],
      [-57.24573007399778, 67.81957009723368],
      [-74.74198803509906, 76.55978940288878],
      [-73.60375960527375, 78.39636019182609],
      [-67.92218140574312, 80.61698801540712],
      [-59.076220860081435, 82.41962573871615],
      [-68.9778162806643, 85.05112877980659],
      [-169.10721706859002, 69.87119013352208],
      [-168.82669211383998, 64.59846733544799],
      [-172.31141325730604, 63.991833108168834],
      [-192.1254235906623, 52.646873605362146],
      [-166.3003429543922, 12.967564352770154],
      [-79.6692367415715, 4.562414945897046],
      [-79.49790751939359, 8.895517276865164],
    ],
  ],
]);

const japanConventionGeometry = turf.polygon([
  [
    [122.40443764161375, 24.25555191895947],
    [123.22422482046358, 22.664415921202675],
    [131.6668409404955, 27.1734104531445],
    [141.6724497786463, 33.41882632781292],
    [152.21247459573226, 45.19087135255526],
    [154.7040665173107, 48.05238412051253],
    [149.47388354609916, 49.86405083649407],
    [144.62198341555745, 55.122855332829886],
    [141.85000003174838, 54.453056889632535],
    [141.56865023975553, 53.237305271866575],
    [141.5658284519161, 52.12730212591498],
    [140.86177532698593, 47.83608043534858],
    [129.38176008175282, 34.88162789041118],
    [122.40443764161375, 24.25555191895947],
  ],
]);
